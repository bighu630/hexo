---
title: nginxä¸€ä¸ªç«¯å£æœåŠ¡å¤šä¸ªç½‘é¡µï¼ˆå¸¦cdn)
author: ivhu
date: 2024-09-06 15:48:05
categories:
  - è®¡ç®—æœº
  - è¿ç»´
tags:
  - cloudflare
  - nginx
description: è¿™ç¯‡åšå®¢ä»‹ç»äº†å¦‚ä½•ä½¿ç”¨Cloudflareå’ŒNginxï¼Œåœ¨åŒä¸€æœåŠ¡å™¨çš„443ç«¯å£ä¸Šæ‰˜ç®¡å¤šä¸ªæœåŠ¡ã€‚é€šè¿‡ä¸ºä¸åŒå­åŸŸåé…ç½®Nginxåå‘ä»£ç†ï¼Œå°†è¯·æ±‚è·¯ç”±åˆ°ä¸åŒçš„æœ¬åœ°æœåŠ¡ï¼Œå¹¶ä½¿ç”¨Cloudflareçš„SSLè¯ä¹¦å’ŒCDNåŠ é€Ÿè®¿é—®ã€‚
---

> è¿™ç¯‡åšå®¢ä»‹ç»äº†å¦‚ä½•ä½¿ç”¨Cloudflareå’ŒNginxï¼Œåœ¨åŒä¸€æœåŠ¡å™¨çš„443ç«¯å£ä¸Šæ‰˜ç®¡å¤šä¸ªæœåŠ¡ã€‚é€šè¿‡ä¸ºä¸åŒå­åŸŸåé…ç½®Nginxåå‘ä»£ç†ï¼Œå°†è¯·æ±‚è·¯ç”±åˆ°ä¸åŒçš„æœ¬åœ°æœåŠ¡ï¼Œå¹¶ä½¿ç”¨Cloudflareçš„SSLè¯ä¹¦å’ŒCDNåŠ é€Ÿè®¿é—®ã€‚

## ç¼˜èµ·

å¤§å­¦çš„æ—¶å€™ä¹°äº†ä¸€ä¸ªé˜¿é‡Œäº‘çš„å°é¸¡ï¼Œä¸€ç›´ç»­è´¹åœ¨ç°åœ¨ï¼Œä¸Šé¢è·‘äº†ä¸å°‘æœåŠ¡ï¼ˆtrilium note,worldpress,calibreï¼‰ï¼Œä½†æ˜¯æœåŠ¡å™¨çš„ç½‘é€Ÿéå¸¸ä½ã€‚

æœ€è¿‘å¬è¯´cdnçš„åŠ é€ŸåŠŸèƒ½ï¼Œå…ˆå°å°èƒ½ä¸èƒ½ç»™æˆ‘çš„æœåŠ¡å™¨æç‚¹é€Ÿã€‚

**å¦‚æœä¸å–œæ¬¢å¬æ•…äº‹ ç›´æ¥è·³è½¬åˆ° `nginxåå‘ä»£ç†å¤šä¸ªåŸŸå` **

## åœ¨æ­¤ä¹‹å‰æˆ‘çš„é…ç½®

å¾ˆæ—©çš„æ—¶å€™æˆ‘è¿˜ä¸ä¼šç»™ç½‘ç«™åŠ https,æˆ‘çš„æœåŠ¡åœ¨å…¬ç½‘ä¸Šä»¥httpè·‘äº†ä¸¤å¹´å¤šï¼Œåé¢æ˜¯åœ¨å¿ä¸äº†ï¼Œç»™æœåŠ¡å™¨ä¹°äº†ä¸ªåŸŸåï¼ˆä»¥å‰ä¸€ç›´æ²¡åŸŸåï¼Œç”¨ipè®¿é—®ğŸ˜€ï¼‰
ç„¶åå¼€å¯äº†æˆ‘çš„httpsé…ç½®ä¹‹æ—….

å…¶ä¸­æœ€æ¶å¿ƒçš„æ˜¯worldpressã€‚æˆ‘çš„worldpressæ˜¯ç”¨dockeræ­å»ºçš„ï¼Œworldpressçš„sslå®ç°æ˜¯ç”¨apatchåšçš„ï¼Œå®ƒåœ¨dockeré‡Œé¢è·‘äº†ä¸€ä¸ªapatchï¼Œæˆ‘å»å®¹å™¨é‡Œé¢ç»™ä»–é…äº†ä¸€ä¸ªapatchğŸ¤®

æœ‰äº†åŸŸåä¹‹åï¼Œæˆ‘çš„ä¸‰ä¸ªæœåŠ¡ä»¥ä¸åŒçš„ç«¯å£è·‘åœ¨æˆ‘çš„æœåŠ¡å™¨ä¸Šï¼Œè®¿é—®çš„æ—¶å€™éƒ½æ˜¯å¸¦ç€ç«¯å£è®¿é—®çš„ï¼ˆå½“ç„¶æˆ‘æ˜¯è®¤ä¸ºæ²¡ä»€ä¹ˆé—®é¢˜ï¼Œå°±æ˜¯ä¸é‚£ä¹ˆå¥½çœ‹ï¼‰

## ç¬¬ä¸€æ¬¡å°è¯•

ä¸¤ä¸ªæœˆå‰å…¶å®å°±å°è¯•è¿‡ç»™ç½‘ç«™å¥—cfçš„cdn,ä½†æ˜¯ä¸€ç›´æ²¡æˆåŠŸï¼ˆå› ä¸ºæˆ‘ç”¨çš„ä¸æ˜¯443ç«¯å£ï¼‰ï¼Œæ— è®ºæˆ‘æ€ä¹ˆå°è¯•ï¼Œå¥—äº†cdnä¹‹åå°±ä¸€ç›´æ˜¯httpèƒ½è®¿é—®ï¼Œhttpsè®¿é—®çš„æ—¶å€™ä¼šä¹‹é™…æŠŠæˆ‘çš„ç«¯å£æŠ¹é™¤ï¼Œæ²¡æœ‰sæˆ‘æ€ä¹ˆå¿å¾—äº†ï¼Œæ‰€ä»¥ç¬¬ä¸€æ¬¡å°è¯•å¤±è´¥äº†

## nginxåå‘ä»£ç†å¤šä¸ªåŸŸå

ä¸ºäº†ä½¿æˆ‘çš„ä¸‰ä¸ªæœåŠ¡éƒ½ç”¨443ç«¯å£ï¼Œç„¶ååœ¨ç”¨cdnå¯¹443ç«¯å£è¿›è¡ŒåŠ é€Ÿ

### æŠŠåŸŸåäº¤ç»™cfæ‰˜ç®¡

è¿™é‡Œæˆ‘å°±ä¸æ•™cfæ€ä¹ˆæ‰˜ç®¡åŸŸåï¼Œç½‘ä¸Šéƒ½æœ‰
æ‰˜ç®¡äº†ä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥åœ¨cfé‡Œé¢æ·»åŠ åŸŸåè§£æ
é‚£ä¹ˆæˆ‘åˆ†åˆ«ä¸ºæˆ‘çš„ä¸‰ä¸ªåŸŸåç”³è¯·äº†3ä¸ªåŸŸå

- blog.domain.com
- note.domain.com
- lib.domain.com

è¿™ä¸‰ä¸ªåŸŸåè§£æçš„åœ°å€éƒ½æ˜¯æˆ‘æœåŠ¡å™¨çš„åœ°å€

> ä»¥ä¸Šåªæ˜¯ä¸¾ä¾‹

![cf](https://pic.imgdb.cn/item/66dab88cd9c307b7e91ddcb9.png)

æ³¨æ„ç‚¹äº®å³è¾¹çš„å°å½©äº‘ï¼ˆè¡¨ç¤ºå¼€å¯cfçš„cdnåŠ é€Ÿ)

### å†™nginxçš„é…ç½®æ–‡ä»¶

nginxæ€ä¹ˆè¿åšçš„æˆ‘è¿™é‡Œå°±ä¸ä»‹ç»äº†ï¼ˆä¸ä¼šçš„å¯ä»¥æœç´¢ä¸€ä¸‹nginxçš„é…ç½®æ–‡ä»¶æ€ä¹ˆå†™ï¼Œå†™å¥½äº†æ”¾é‚£å„¿ï¼Œæ€ä¹ˆå¼€å¯nginx,æ€ä¹ˆé‡è½½nginxçš„é…ç½®æ–‡ä»¶ï¼‰

è¿™é‡Œç»™å‡ºgptç»™æˆ‘çš„é…ç½®æ–‡ä»¶

```c
# ç¬¬ä¸€ä¸ªç½‘ç«™çš„é…ç½®ï¼Œä»£ç†åˆ° localhost:3001  # å‡è®¾æˆ‘çš„3001æ˜¯å›¾ä¹¦é¦†çš„æœåŠ¡åœ°å€
server {
    listen 443 ssl;
    server_name lib.domain.com; # å›¾ä¹¦è§‚çš„åŸŸå

    # SSL è¯ä¹¦
    ssl_certificate /etc/nginx/ssl/example1.com.crt;
    ssl_certificate_key /etc/nginx/ssl/example1.com.key;

    location / {
        proxy_pass http://localhost:3001;  # ä»£ç†åˆ°æœ¬åœ°çš„ 3001 ç«¯å£
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}

# ç¬¬äºŒä¸ªç½‘ç«™çš„é…ç½®ï¼Œä»£ç†åˆ° localhost:3002   # å‡è®¾æ˜¯æˆ‘çš„åšå®¢
server {
    listen 443 ssl;
    server_name blog.domain.com;

    # SSL è¯ä¹¦
    ssl_certificate /etc/nginx/ssl/example2.com.crt;
    ssl_certificate_key /etc/nginx/ssl/example2.com.key;

    location / {
        proxy_pass http://localhost:3002;  # ä»£ç†åˆ°æœ¬åœ°çš„ 3002 ç«¯å£
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

**å…³äºä¸Šé¢çš„é…ç½®**
æ­£å¸¸æƒ…å†µæ²¡æœ‰å¤šå°‘è¦ä¿®æ”¹çš„

- server_name: è¿™é‡Œå†™ä½ åœ¨cfä¸Šç”³è¯·çš„åŸŸå
- ssl_certificate: è¯ä¹¦çš„è·¯å¾„,ä¸€èˆ¬æƒ…å†µä½ éœ€è¦å»è´­ä¹°è¯ä¹¦ï¼Œä½†æ˜¯ä½¿ç”¨cfåšcdn ä½ å¯ä»¥ä½¿ç”¨cfä¸­çš„è¯ä¹¦ï¼ˆä¹Ÿå¯ä»¥è‡ªå·±ç”Ÿæˆè¯ä¹¦ï¼Œåªéœ€è¦æŠŠcfé‡Œé¢çš„sslå®‰å…¨ç­‰çº§å¼€åˆ°å®Œå…¨å¦‚ä¸‹å›¾ï¼‰
  ![ssl](https://pic.imgdb.cn/item/66dabaafd9c307b7e9234c74.png)

  - ä½¿ç”¨cfä¸­çš„è¯ä¹¦: åœ¨è¿™ä¸ªé¡µé¢ä¸ºä½ çš„åŸŸåç”³è¯·è¯ä¹¦(å¦‚æœä¸æ‡‚å°±è€è€å®å®ç”¨`å®Œå…¨æ¨¡å¼` æˆ–è€…è‡ªå·±ä¹°è¯ä¹¦)

    ![æœåŠ¡å™¨è¯ä¹¦](https://pic.imgdb.cn/item/66dabaf8d9c307b7e923a372.png)

- proxy_pass: è¿™é‡Œå¡«æˆ‘ä»¬çœŸæ­£æœåŠ¡çš„åœ°å€

è¿™æ—¶æˆ‘ä»¬è®¿é—®`lib.domain.com` å°±ä¼šè¢«nginxè·¯ç”±åˆ° `http://localhost:3001` ä¸Š

è®¿é—® `blog.domain.com` å°±ä¼šè¢«nginxè·¯ç”±åˆ° `http://localhost:3002` ä¸Š

## ç¼˜æ•£

è‡³æ­¤ï¼Œåœ¨åŒä¸€ä¸ªæœåŠ¡å™¨çš„443ç«¯å£å¼€å¯äº†å¤šä¸ªç½‘é¡µï¼Œä½†æ˜¯åœ¨è®¿é—®çš„æ—¶å€™æˆ‘ä»¬ç”¨çš„æ˜¯ä¸åŒçš„åŸŸå
